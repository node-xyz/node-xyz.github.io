<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Transport/Transport.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="GenericMiddlewareHandler.html">GenericMiddlewareHandler</a><ul class='methods'><li data-type='method'><a href="GenericMiddlewareHandler.html#apply">apply</a></li><li data-type='method'><a href="GenericMiddlewareHandler.html#getMiddlewares">getMiddlewares</a></li><li data-type='method'><a href="GenericMiddlewareHandler.html#inspect">inspect</a></li><li data-type='method'><a href="GenericMiddlewareHandler.html#inspectJSON">inspectJSON</a></li><li data-type='method'><a href="GenericMiddlewareHandler.html#register">register</a></li><li data-type='method'><a href="GenericMiddlewareHandler.html#remove">remove</a></li></ul></li><li><a href="HTTPServer.html">HTTPServer</a><ul class='methods'><li data-type='method'><a href="HTTPServer.html#terminate">terminate</a></li></ul></li><li><a href="NodeXYZ.html">NodeXYZ</a><ul class='methods'><li data-type='method'><a href="NodeXYZ.html#bootstrap">bootstrap</a></li><li data-type='method'><a href="NodeXYZ.html#call">call</a></li><li data-type='method'><a href="NodeXYZ.html#id">id</a></li><li data-type='method'><a href="NodeXYZ.html#inspect">inspect</a></li><li data-type='method'><a href="NodeXYZ.html#inspectJSON">inspectJSON</a></li><li data-type='method'><a href="NodeXYZ.html#middlewares">middlewares</a></li><li data-type='method'><a href="NodeXYZ.html#register">register</a></li><li data-type='method'><a href="NodeXYZ.html#registerClientRoute">registerClientRoute</a></li><li data-type='method'><a href="NodeXYZ.html#registerServer">registerServer</a></li><li data-type='method'><a href="NodeXYZ.html#registerServerRoute">registerServerRoute</a></li><li data-type='method'><a href="NodeXYZ.html#removeClientRoute">removeClientRoute</a></li><li data-type='method'><a href="NodeXYZ.html#removeServer">removeServer</a></li><li data-type='method'><a href="NodeXYZ.html#setSendStrategy">setSendStrategy</a></li><li data-type='method'><a href="NodeXYZ.html#terminate">terminate</a></li></ul></li><li><a href="ServiceRepository.html">ServiceRepository</a><ul class='methods'><li data-type='method'><a href="ServiceRepository.html#bindTransportEvent">bindTransportEvent</a></li><li data-type='method'><a href="ServiceRepository.html#call">call</a></li><li data-type='method'><a href="ServiceRepository.html#forget">forget</a></li><li data-type='method'><a href="ServiceRepository.html#inspect">inspect</a></li><li data-type='method'><a href="ServiceRepository.html#inspectJSON">inspectJSON</a></li><li data-type='method'><a href="ServiceRepository.html#joinNode">joinNode</a></li><li data-type='method'><a href="ServiceRepository.html#kickNode">kickNode</a></li><li data-type='method'><a href="ServiceRepository.html#logSystemUpdates">logSystemUpdates</a></li><li data-type='method'><a href="ServiceRepository.html#register">register</a></li><li data-type='method'><a href="ServiceRepository.html#registerServer">registerServer</a></li><li data-type='method'><a href="ServiceRepository.html#terminate">terminate</a></li></ul></li><li><a href="Transport.html">Transport</a><ul class='methods'><li data-type='method'><a href="Transport.html#registerRoute">registerRoute</a></li><li data-type='method'><a href="Transport.html#removeRoute">removeRoute</a></li><li data-type='method'><a href="Transport.html#send">send</a></li></ul></li><li><a href="xReceivedMessage.html">xReceivedMessage</a></li></ul><h3>Modules</h3><ul><li><a href="module-bootstrapFunctions.html">bootstrapFunctions</a><ul class='methods'><li data-type='method'><a href="module-bootstrapFunctions.html#~_basicPingBootstrap">_basicPingBootstrap</a></li><li data-type='method'><a href="module-bootstrapFunctions.html#~_processInspectionEvent">_processInspectionEvent</a></li><li data-type='method'><a href="module-bootstrapFunctions.html#~_processNetworkEvent">_processNetworkEvent</a></li><li data-type='method'><a href="module-bootstrapFunctions.html#~_udpTunnel">_udpTunnel</a></li></ul></li><li><a href="module-Configuration.html">Configuration</a><ul class='methods'><li data-type='method'><a href="module-Configuration.html#~addServer">addServer</a></li><li data-type='method'><a href="module-Configuration.html#~ensureNode">ensureNode</a></li><li data-type='method'><a href="module-Configuration.html#~forget">forget</a></li><li data-type='method'><a href="module-Configuration.html#~getSelfConf">getSelfConf</a></li><li data-type='method'><a href="module-Configuration.html#~getSystemConf">getSystemConf</a></li><li data-type='method'><a href="module-Configuration.html#~joinNode">joinNode</a></li><li data-type='method'><a href="module-Configuration.html#~joinNode">joinNode</a></li><li data-type='method'><a href="module-Configuration.html#~removeServer">removeServer</a></li><li data-type='method'><a href="module-Configuration.html#~setSelfConf">setSelfConf</a></li><li data-type='method'><a href="module-Configuration.html#~setSystemConf">setSystemConf</a></li></ul></li><li><a href="module-service-middlewares.html">service-middlewares</a><ul class='methods'><li data-type='method'><a href="module-service-middlewares.html#~_braodcastGlobal">_braodcastGlobal</a></li><li data-type='method'><a href="module-service-middlewares.html#~_braodcastLocal">_braodcastLocal</a></li><li data-type='method'><a href="module-service-middlewares.html#~_firstFind">_firstFind</a></li><li data-type='method'><a href="module-service-middlewares.html#~_sendToAll">_sendToAll</a></li><li data-type='method'><a href="module-service-middlewares.html#~_sendToTarget">_sendToTarget</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/Transport/Transport.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const logger = require('./../Log/Logger')
const CONFIG = require('./../Config/config.global')
const GenericMiddlewareHandler = require('./../Middleware/generic.middleware.handler')
const wrapper = require('./../Util/Util').wrapper
const HTTPServer = require('./HTTP/http.server')
const UDPServer = require('./UDP/udp.server')
const xSentMessage = require('./xSentMessage')
const xSentMessageMwParam = require('./xSentMessageMwParam')

class Transport {

  /**
   * Transport layer. This layer is an abstraction above all different sorts of communication.
   */
  constructor (xyz) {
    this.xyz = xyz

    this.routes = {}
    this.servers = {}

    let callDispatchMiddlewareStack = new GenericMiddlewareHandler(this.xyz, 'call.dispatch.mw', 'CALL')
    callDispatchMiddlewareStack.register(-1, require('./Middlewares/call/http.export.middleware'))
    this.registerRoute('CALL', callDispatchMiddlewareStack)
  }

  inspect () {
    let ret = `${wrapper('green', wrapper('bold', 'outgoing middlewares'))}:\n`
    for (let route in this.routes) {
      ret += `    ${this.routes[route].inspect()}\n`
    }
    ret += '\n'
    for (let s in this.servers) {
      ret += `  ${wrapper('bold', wrapper('magenta', this.servers[s].constructor.name + ' @ ' + s))} ::\n`
      ret += `    ${this.servers[s].inspect()}\n`
    }
    return ret
  }

  inspectJSON () {
    let ret = {'outgoingRoutes': [], servers: []}
    for (let route in this.routes) {
      ret.outgoingRoutes.push(this.routes[route].inspectJSON())
    }

    for (let s in this.servers) {
      ret.servers.push(this.servers[s].inspectJSON())
    }
    return ret
  }

  /**
   *
   * opt should have:
   *   - node {string} address of destination,
   *   - route {string} url of outgoing middleware stack
   *   - payload {object}. depending on `route` , it can have `userPayload`, `service` or `_id`
   * @param opt {Obeject} the options object.
   * @param responseCallback {Function} the callback of the message. Note that this is valid
   * only for http calls. UDP / TCP calls do not have a callback
   */
  send (opt, responseCallback) {
    opt.route = opt.route || 'CALL'

    if (!this.routes[opt.route]) {
      logger.error(`attempting to send message in route ${opt.route}. DOES NOT EXIST`)
      responseCallback('outgoing message route not found', null)
      return
    }

    let _port
    // TODO: BUG
    // here we are assuming that a route is unique in each NODE, not server
    // it should be checked...
    if (opt.redirect) {
      _port = this._findTargetPort(opt.route, opt.node)
      if (_port === -1) {
        logger.error(`Transport Client :: could not find route ${opt.route} in destination node ${opt.node}. aborting transmission`)
        if (responseCallback) {
          responseCallback('target port/route not found', null)
        }
        return
      }
    }

    let message = {
      userPayload: opt.payload,
      xyzPayload: {
        senderId: this.xyz.id().netId,
        service: opt.service
      }
    }

    // the json key
    let xMessage = new xSentMessage(message)

    let requestConfig = {
      hostname: `${opt.node.split(':')[0]}`,
      port: _port || `${opt.node.split(':')[1]}`,
      path: `/${opt.route}`,
      method: 'POST',
      json: xMessage
    }

    // mw param
    let xMessageParam = new xSentMessageMwParam({
      requestConfig: requestConfig,
      responseCallback: responseCallback
    })

    logger.debug(`${wrapper('bold', 'Transport Client')} :: sending message to ${wrapper('bold', requestConfig.hostname)}:${requestConfig.port}/${opt.route} through ${this.routes[opt.route].name} middleware :: message ${JSON.stringify(xMessage)}`)

    this.routes[opt.route].apply(xMessageParam, 0)
  }

  registerServer (type, port, e) {
    let server
    if (type === 'HTTP') {
      server = new HTTPServer(this.xyz, port)
      this.servers[port] = server
      CONFIG.addServer({type: type, port: port, event: e})
      return server
    } else if (type === 'UDP') {
      server = new UDPServer(this.xyz, port)
      this.servers[port] = server
      CONFIG.addServer({type: type, port: port, event: e})
      return server
    } else {
      logger.error(`transport server type ${type} undefined`)
      return false
    }
  }

  /**
   * Creates a new client route
   * @param {String} prefix
   * @param {Object} [gmwh] The GenericMiddlewareHandler instance to use for
   * this route. will create a new one if not provided.
   *
   */
  registerRoute (prefix, gmwh) {
    logger.info(`Transport :: new outgoing message route ${wrapper('bold', prefix)} added`)
    if (gmwh) {
      this.routes[prefix] = gmwh
    } else {
      logger.warn(`Transport :: no middlewareHandler defined for route ${prefix}. an empty one will be used`)
      this.routes[prefix] = new GenericMiddlewareHandler(this.xyz, `${prefix}.dispatch.mw`, prefix)
    }
    return 1
  }

  /**
   * Removes a client route
   */
  removeRoute (prefix) {
    if (this.routes[prefix]) {
      delete this.routes[prefix]
      logger.info(`TRANSPORT :: route ${prefix} removed.`)
      return 1
    } else {
      logger.error(`TRANSPORT :: attempting to remove route ${prefix} which does not exist.`)
      return -1
    }
  }

  getServerRoutes () {
    let ret = {}
    for (let s in this.servers) {
      ret[s] = Object.keys(this.servers[s].routes)
    }
    return ret
  }

  _findTargetPort (route, node) {
    let foreignRoutes = this.xyz.serviceRepository.foreignRoutes[node]
    for (let p in foreignRoutes) {
      for (let r of foreignRoutes[p]) {
        if (r === route) {
          return p
        }
      }
    }
    return -1
  }

  _checkUniqueRoute (prefix) {
    for (let s in this.servers) {
      for (let r in this.servers[s].routes) {
        if (r === prefix) {
          return false
        }
      }
    }
    return true
  }

}

module.exports = Transport
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Mar 31 2017 19:49:26 GMT+0430 (IRDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>

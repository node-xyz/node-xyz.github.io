<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>NODE XYZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/assets/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- <link rel="stylesheet" href="/assets/css/main.css"> -->
  <link rel="stylesheet" href="/assets/css/stylish.css">

  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>

</head>

<body>

<style media="screen">
body {
  background-color: var(--light-color);
  color: var(--dark-color)
}
</style>
<style media="screen">
/* Nav */
#mainNav {
  color: var(--light-color) !important;
}

</style>

<nav class="navbar navbar-inverse" style="margin:0" id="mainNav">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand spacing" href="/">NODE XYZ</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Repositories <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="padding"> CORE REPOSITORIES </li>
            <li><a href="https://github.com/node-xyz/xyz-core" class="spacing">xyz.core</a></li>
            <li><a href="https://github.com/node-xyz/xyz-cli" class="spacing">xyz.cli</a></li>
            <li role="separator" class="divider"></li>
            <li class="padding"> ADDITIONAL </li>
            <li><a href="https://github.com/node-xyz/xyz.monitor.basic.bootstrap" class="spacing">xyz.monitor</a></li>
            <li><a href="https://github.com/node-xyz/xyz.ping.swim.bootstrap" class="spacing">xyz.ping.swim</a></li>
            <li><a href="https://github.com/node-xyz/xyz.ping.stochastic.bootstrap" class="spacing">xyz.ping.stochastic</a></li>
          </ul>
        </li>
      </ul>

      <ul class="nav navbar-nav navbar-left">
        <!-- <li><a href="#">Link</a></li> -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Documentations <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="padding"> READING </li>
            <li><a href="/documentations/getting-started">Getting Started</a></li>
            <li><a href="/documentations/advance">Advance Topics</a></li>
            <li><a href="/apidoc">API DOC</a></li>
            <li role="separator" class="divider"></li>
            <li class="padding"> EXAMPLES </li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.getting.started">xyz.getting.started</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.logger.bootstrap">xyz.logger.bootstrap</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.auth.basic.receive">xyz.auth.basic.receive</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.auth.basic.send">xyz.auth.basic.send</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="container">

  <ol class="breadcrumb" style="margin: 10px; color: white;">
    <li><a class='spacing' href="/">Node XYZ </a></li>
    
    
    
    
    
    
    
    

    
      

    
      
      
      <li >
        <a style="color: inherit" href="/documentations/">documentation</a>
      </li>
      
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      
      
    
    
    
    

    
      

    
      

    
      

    
      

    
      

    
      
      
      <li class="active">
        <a style="color: inherit" href="/documentations/getting-started/">getting-started</a>
      </li>
      
      

    
      

    
      

    
      
      
    </ol>

    <hr>


    <div class="row">
  <div class="col col-md-2" id="__side">
    <div id="___side">
      <p class="spacing"> CONTENTS </p>
      <ol style="padding-left:5px">
      </ol>

    </div>
  </div>

  <div class="col col-md-10">
    <h1 id="hello-xyz">Hello XYZ</h1>

<p>This brief tutorial will help you get started with XYZ. Although it’s a <strong>Getting-Started</strong> tutorial, but it also covers a great deal of fundamental information.</p>

<p>The only dependency of this tutorial is <code class="highlighter-rouge">xyz-core</code>, which has only one logging dependency itself. You can install it  in your woking directory using:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ npm install xyz-core --save
</code></pre>
</div>

<p>The code and test cases of this documentation is available <a href="https://github.com/node-xyz/xyz.example.getting.started">here</a>.</p>

<p>Let’s get this tutorial started!</p>

<h3 id="baby-microservice">Baby Microservice</h3>

<p>Assume that we only have two services that will communicate with each other. Suppose that each of these services (aka. Node modules) have another API exposed two end users. That is not our business at the moment, since XYZ will divide <strong>the matter of end user</strong> and the <strong>matter of system</strong>. This means that although you can have end user calling the APIs created in this tutorial, their main goal is to serve other nodes inside your own system. In this section, our goal is to focus on what is important to our own system.</p>

<p>The – dummy – services are as follows:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// math.ms.js</span>
<span class="c1">// a very fancy math module with super fast calculation</span>
<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mul</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
<span class="p">}</span>

<span class="c1">// string.ms.js</span>
<span class="c1">// some ultra fast string manipulations</span>
<span class="kd">function</span> <span class="nx">up</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">down</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Note that these functionalities are, of course, way to small and naive to be exposed as a standalone service, even in a microservice architecture. But we will stick to these services, <strong>Math</strong> and <strong>String</strong> in some of our tutorial to keep things simple.</p>

<p>Now, assume that these services need to call each other in order to share their services, or more realistic, in order to do something for the end-user. This is the first place that XYZ will come to action.</p>

<p>In order to have two xyz instances communicate with each other, they need to have a system, a <strong>shared</strong> system. Information about the system is filled to the xyz instance using a <code class="highlighter-rouge">config</code> parameter. The config parameter has information such as local <code class="highlighter-rouge">port</code>/<code class="highlighter-rouge">ip</code>/<code class="highlighter-rouge">service name</code> and a list of nodes who live inside the system. Note that a node can join the system without being in the static list (more on this later), this is just a basic example!</p>

<p>Our two services are going to be deployed with the following topology:</p>

<ul>
  <li>math.ms will be hosted on port 4000 of the local machine</li>
  <li>string.ms will be hosted on port 5000 of the local machine</li>
</ul>

<p>Therefore, we need to pass the address of the other node to each of the nodes. This will be placed inside <code class="highlighter-rouge">systemConf.nodes</code>.</p>

<p>Let’s look at the <code class="highlighter-rouge">math.ms.js</code> first:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// math.ms.js</span>
<span class="c1">// a very fancy math module with super fast calculation</span>
<span class="kd">let</span> <span class="nx">XYZ</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz-core'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">mathMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// will indicate the name of the sevice in logs</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'math.ms'</span><span class="p">,</span>
    <span class="c1">// default hostname</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// list of other addresses</span>
    <span class="na">nodes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'127.0.0.1:5000'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// expose these function over the system</span>

<span class="nx">mathMS</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'mul'</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">jsonify</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">mathMS</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">jsonify</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="p">})</span></code></pre></figure>

<p>Strange thing is that we did not tell <code class="highlighter-rouge">math.ms</code> to place itself on port 4000. Why?</p>

<blockquote>
  <p>Each node will load itself with one HTTP server on port 4000 by default. You can read more about thr default values in <a href="">Configuration</a> section and more about Servers in <a href="">Server Management</a> section</p>
</blockquote>

<p>And the <code class="highlighter-rouge">string.ms</code> is fairly similar. We expose some functions relating to string objects. The most important difference is that now we must explicitly tell <code class="highlighter-rouge">string.ms</code> to listen on port 5000. This can be done using the <code class="highlighter-rouge">selfConf.transport[]</code> array.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//string.ms.js</span>
<span class="kd">let</span> <span class="nx">XYZ</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz-core'</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">stringMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'string.ms'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="na">transport</span><span class="p">:</span> <span class="p">[{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'HTTP'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}]</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">nodes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'127.0.0.1:4000'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="nx">stringMS</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'up'</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">jsonify</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span>
<span class="p">})</span>
<span class="nx">stringMS</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'down'</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">jsonify</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span>
<span class="p">})</span></code></pre></figure>

<p>Now, if you run both <code class="highlighter-rouge">math.ms.js</code> and <code class="highlighter-rouge">string.ms.js</code>, you’ll notice that… well, nothing is yet happening because we didn’t write any code for anything to happen! We will add some code in a minute to have one service calling the other one.</p>

<blockquote>
  <p>I see an error: <code class="highlighter-rouge">[math.ms@127.0.0.1:4000] error :: Ping Error :: 127.0.0.1:5000 has been out of reach for x pings :: ... </code></p>
</blockquote>

<p>This is natural. XYZ has a built in and configurable service discovery mechanism out of the box. You can disable it of course, but it will work by default. This is error is because each node will iteratively check other node’s health by pinging it and the reason you are seeing this is because <code class="highlighter-rouge">string.ms</code> was not able to respond to a ping message. This error should go away as you run <code class="highlighter-rouge">string.ms</code></p>

<blockquote>
  <p><strong>notes about the default ping</strong>: XYZ offers a few ping strategies, explained in a different section (<a href="">Ping Types</a>). The <a href="">default ping</a> is a naive, yet reliable approach which is easy and appropriate to use in test environmetns. Using the default ping, each node will probe other nodes and wait for a response. If a node is out of reach for 10 pings, it will be removed from the <code class="highlighter-rouge">systemConf.nodes[]</code>. The default interval for pinging is 2000ms.</p>
</blockquote>

<p>Moving away from all that ping stuff. Now, thanks to the service discovery mechanism, our services are virtually binded to one another and they can call the services that each of them is exposing using <code class="highlighter-rouge">.register()</code>. The good part of <code class="highlighter-rouge">.register()</code> is that the callee is transparent to the location of this function (or at least, has the option to be) and can call it very easily. Let’s see how:</p>

<p>Add the following to <code class="highlighter-rouge">string.ms.js</code>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// .call will invoke a foreign (or even local) service exposed using .register</span>
  <span class="c1">// servicePath must be identical in caller and callee</span>
  <span class="nx">stringMS</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="na">servicePath</span><span class="p">:</span> <span class="s1">'mul'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">}},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">response</span> <span class="nx">of</span> <span class="nx">mul</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">body</span><span class="p">}</span> <span class="p">[</span><span class="nx">err</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}]</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">)</span></code></pre></figure>

<p>You should now see an output like:
<code class="highlighter-rouge">response of mul =&gt; 10 [err null]</code></p>

<h4 id="a-note-on-terminology">A Note on terminology.</h4>

<p>Before going any further, it is important to be on the same page regarding terminology.</p>

<ul>
  <li><span class="spacing"> SERVICE </span>: each function – or literally any piece of code – exposed via <code class="highlighter-rouge">.register</code> is a <strong><em>service</em></strong>.</li>
  <li><span class="spacing"> NODE </span>: Each <em>Node Process</em>, having a number of <em>services</em> exposed using <code class="highlighter-rouge">xyz-core</code> and <code class="highlighter-rouge">.register()</code> is called a <strong>node</strong>.</li>
</ul>

<h4 id="whats-next">What’s next?</h4>

<p>In this example we hardcoded the list of service, so that they can communicate with each other. This is… just about ok. It is not awesome. What would be awesome is to have nodes joining the system dynamically. Yes, that’s what we’re going to do in the Next Section. Aside from being way less <em>Cool</em>, having a fixed list of nodes in a [micro]service based architecture is almost useless. There is a pretty good chance of having <em>new nodes</em>, or seeing <em>existing nodes crash or restart</em>. We can not achieve a <strong><em>proper service discovery</em></strong> using a fixed list of nodes.</p>

<p>Furthermore, you can even test this flaw in the current system. If you kill <code class="highlighter-rouge">math.ms</code>, you’ll seee immediatly that the response of <code class="highlighter-rouge">.call()</code> changes to <code class="highlighter-rouge">null</code>. And the sad part is that if you do not re-lunch <code class="highlighter-rouge">math.ms</code> before 10 ping cycles is over, <code class="highlighter-rouge">string.ms</code> will remove it from its <code class="highlighter-rouge">systemConf</code> (literrly, it will forget about <code class="highlighter-rouge">math.ms</code> and remove all of its information. like a sad break-up) and there is no coming back from this. (just kidding. there is a way called <code class="highlighter-rouge">seed nodes</code> and we will get to it soon)</p>

<h1 id="replicating-your-nodes-and-services">Replicating Your Nodes and Services</h1>

<p>In the end of the last section, we reached a conclusion:</p>

<p>It would have been much more interesting, if we could add nodes dynamically. Good news: we can.</p>

<p>XYZ nodes can join a system, given that they have a [list of] seed node[s]. Seed nodes are the entry point to the system. They should check the authority of the incoming node, if required, and pass the list of nodes available inside the system to it, or any other authentication certificate, again, if required. The fact that there are a lots of ‘ <em>if required</em> ‘ phrases in the last statement is that all of these steps (like any authentication or certificate exchange) are optional and the developer can choose to have them. In the most <strong><em>Wildcard</em>-ish</strong> scenario, all nodes are open to accpeing join requests and any other node can join them only by knowing their IP address.</p>

<p>This <strong>Join Mechanism</strong> is a subset of the <strong>Ping Mechanism</strong>. In other words, every ping mechanism should implement how and when join requests should be accepted. Since the <a href=""><em>default ping</em></a> is pretty naive and focuses of test and developement phases, it does not <strong>enforce</strong> any authentication. Albeit, we will see in the end of this tutorial that we can modify this behaviour with some small changes.</p>

<p>Let’s assume that both the string.ms and <em>math.ms</em> in the previous section do not know each other beforehand. That is to say, their <code class="highlighter-rouge">systemConf.nodes[]</code> is empty:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">stringMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'string.ms'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="na">transport</span><span class="p">:</span> <span class="p">[{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'HTTP'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}]</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span><span class="na">nodes</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span></code></pre></figure>

<p>and</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">mathMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'math.ms'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span><span class="na">nodes</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span></code></pre></figure>

<blockquote>
  <p>Note that you can omit putting the empty <code class="highlighter-rouge">nodes: []</code> in your config file. In fact, you can initialize youre system using <code class="highlighter-rouge">new XYZ({})</code>. See the <a href="">Configuration</a> section for more information about the default valuse.</p>
</blockquote>

<p>Furthermore, let’s assume that the <code class="highlighter-rouge">math.ms</code> is the constant node in the system and <code class="highlighter-rouge">string.ms</code>’s are going to come and go. Go ahead and run the <code class="highlighter-rouge">math.ms.js</code> alone, you will see that nothing happens. It’s ok. math.ms does nothing.</p>

<p>Now run the <code class="highlighter-rouge">string.ms.js</code>. you’ll see:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[2017-3-6 16:11:30][string.ms@127.0.0.1:5000] warn :: Sending a message to /mul from first find strategy failed (Local Response)
response of mul =&gt; null [err Not Found]
</code></pre>
</div>

<p>The <a href="">first find strategy</a> is a default behavior embedded inside node XYZ for finding nodes to send messages to. In more advanced sections of this documentation, you’ll learn that the <code class="highlighter-rouge">sendStrategy</code> is actuallya middleware in <code class="highlighter-rouge">xyz-core</code>. This enables you to change any function inside the middleware at runtime. More on this later!</p>

<p>The main point is that <strong>the message failed</strong>. Obviously because string.ms does not know any math.ms at this point, so it does not actually send the message to the network and instead, it will locally respond to it with en error.</p>

<p>Change the <code class="highlighter-rouge">string.ms.js</code> to the following, specifying a new <strong>seed node</strong> for it.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">stringMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'string.ms'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="c1">// new parameter</span>
    <span class="na">seed</span><span class="p">:</span> <span class="p">[</span><span class="s1">'127.0.0.1:4000'</span><span class="p">],</span>
    <span class="na">transport</span><span class="p">:</span> <span class="p">[{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'HTTP'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}]</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span><span class="na">nodes</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span></code></pre></figure>

<p>Note that you do not need to chnage <code class="highlighter-rouge">math.ms.js</code> at all. Joining is a part of Ping and pings a er configured using a different approach  (if you are curious, using <a href="">Bootstrap Functions</a>), not using the xyz constructor.</p>

<p>Now, the two nodes have no previous knowledge of each other, yet they can join and work with each other. Go ahead and run the math.ms, next run the string.ms in a separate terminal and see the results. As you see, the output is still the same. You might also see a <code class="highlighter-rouge">info</code> log indicating that join has been successfully approved.</p>

<p>in <code class="highlighter-rouge">string.ms.js</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>string.ms@127.0.0.1:5000] info :: JOIN PING ACCEPTED. response : ...
</code></pre>
</div>

<p>in <code class="highlighter-rouge">math.ms.js</code>:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[math.ms@127.0.0.1:4000] info :: A new node {127.0.0.1:5000} added to systemConf
</code></pre>
</div>

<p>This get’s even more interesting when we add more nodes. You can add more string.ms nodes and see that all of them will eventually find the math.ms and can connect with it. To be more accurate, the do not just find <code class="highlighter-rouge">math.ms</code>, they find all of the nodes in the system, including the previously deployed <code class="highlighter-rouge">string.ms</code>s.</p>

<p>To test this, there is only one small problem. All string.ms ss are configured to use one port. Hopefully, XYZ provides a way to override any configuration, for debugging purposes mainly. We’ll cover this later (see [Configuration] for more detail), but, for now, you can use the <code class="highlighter-rouge">--xyz-transport.0.port</code> command line argument to override the port. Run many many more StringMS instances with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>node string.ms.js --xyz-transport.0.port 5001
<span class="gp">$ </span>node string.ms.js --xyz-transport.0.port 5002
<span class="gp">$ </span>node string.ms.js --xyz-transport.0.port 5003
...</code></pre></figure>

<blockquote>
  <p>The <code class="highlighter-rouge">--xyz</code> prefix is backdoor for overriding <strong>any</strong> value in <code class="highlighter-rouge">selfConf</code>. Keeping this in mind, I think you can find the relation between <code class="highlighter-rouge">--xyz-transport.0.port 5001</code> and <code class="highlighter-rouge">selfConf : {transport: [{type: 'HTTP', port:  5001}]}</code></p>
</blockquote>

<p>All of your logs should indicate that all <code class="highlighter-rouge">string.ms</code> nodes are calling <code class="highlighter-rouge">mul</code> successfully and all nodes should be logged <code class="highlighter-rouge">joined</code> in <code class="highlighter-rouge">math.ms</code>.</p>

<p>A question might come to mind at this point. We have many sender nodes, and only just one receiver node in this example. So… it is kinda obvious how each request gets routed. In other words, a <code class="highlighter-rouge">string.ms</code> does not have that much of an option!</p>

<p>Assume that we have two receiver nodes (math.ms) and a dozen sender nodes, how could we decide on one of the math.ms nodes?</p>

<p>You might argue that this is a matter that xyz should handle. Indeed, we do handle it. it’s just that we are very keen to keep you involved whit what’s happening under the hood, so that you can change it when required.</p>

<p>In order to have different message routing ways, xyz supports two mechanisms:</p>

<ol>
  <li>Service Discovery middlewares</li>
  <li>Path based service identification</li>
</ol>

<p>The upcoming sections will describe these concepts.</p>

<p>Before going into the next section, you might argue that why is this so important? In a microservice-based system, it is crucially important!</p>

<p>If you think about the system as a whole, you come to realize that many many types of messages might be sent. One node might want to broadcast a message to <strong>all other nodes</strong>, or to a subset of them. A node might want to apprise just a few database nodes about a record update, and many many more events that might happen!</p>

<h1 id="service-discovery">Service Discovery</h1>

<p>As mentioned in the previous section, the process of choosing a destination node when making a call is rather difficult and obscure. XYZ provides a configuration for each of the nodes, so that each node can actually choose a strategy for sending a message. Note that each node can have its own <code class="highlighter-rouge">sendStrategy</code>.</p>

<p>The good thing about the <code class="highlighter-rouge">sendStrategy</code> is that it is a <strong>plugin</strong> (aka. middleware). these middlewares are completely modifiable. That is to say, you can write your own strategy and patch it into your system.</p>

<p>Although one of the reasons for having send strategies as a plugin is to keep the main repository minimal ,<code class="highlighter-rouge">xyz-core</code> has a few fundamental send strategies built in:</p>

<ul>
  <li><span class="spacing"> <a href="">xyz.first.find</a> </span> . <strong><em>Note that this is the default sendStrategy</em></strong>.</li>
  <li><span class="spacing"> <a href="">xyz.send.to.all</a> </span></li>
  <li><span class="spacing"> <a href="">xyz.send.to.target</a> </span></li>
  <li><span class="spacing"> <a href="">xyz.broadcast.local</a> </span></li>
  <li><span class="spacing"> <a href="">xyz.broadcast.global</a> </span></li>
</ul>

<p>In this tutorial we are only interested in the first two.</p>

<p>We will avoid going into the code of these middlewares(although they are fairly simple and you can probably get a feeling by seeing the source code), but it is crucially important to understand exactly what they are doing.</p>

<p>The <code class="highlighter-rouge">sendStrategy</code> middleware has the following main duty:</p>

<blockquote>
  <p>it must receive all of the parameters that you pass to <code class="highlighter-rouge">.call()</code>, with some additional information that <code class="highlighter-rouge">xyz-core</code> injects to it, and pass this message request to the <code class="highlighter-rouge">Transport</code> layer.</p>
</blockquote>

<p>(You will soon understand clearly what the <strong>Transport layer</strong> is. For now you can assume that it handles network messages.)</p>

<p>In other words, (at least using <code class="highlighter-rouge">xyz.first.find</code>) you never call a service by specifying its exact <code class="highlighter-rouge">ip:port</code>. <strong>This information will be discovered using sendStrategy</strong>. (awkward side note: <code class="highlighter-rouge">xyz.send.to.target</code> is a sendStrategy middleware that accepts the ip and port of the destination from you and redirects the message exactly to that node, regardless of any other information)</p>

<p>In order to investigate the last sentence better, let’s verbally describe how <code class="highlighter-rouge">xyz.first.find</code> does its duty:</p>

<ol>
  <li>After you send a message using <code class="highlighter-rouge">.call()</code>, the send strategy function will be invoked. this function has access to all of the parameters of <code class="highlighter-rouge">.call()</code> and some additional data.</li>
  <li>One of these additional data, is list of functions exposed by <strong>all of the nodes in the system</strong>. This information is persisted throughout the system during ping calls.</li>
  <li>Assuming that you called a service with <code class="highlighter-rouge"><span class="p">{</span><span class="err">servicePath:</span><span class="w"> </span><span class="err">'foo'</span><span class="p">}</span></code>, <code class="highlighter-rouge">xyz.first.find</code> will then search this list and find all of the nodes that have enlisted <code class="highlighter-rouge">foo</code> as on of their functions.</li>
  <li>Finally it will invoke the Transport layer <strong>with the ip and port of the first node</strong> in the list that can response to this message. (and the rest of the job will be carried by the Transport layer middlewares).</li>
</ol>

<p>The <code class="highlighter-rouge">send.to.all</code> works in similar manner, but it will send the message to <strong>all of the nodes that have <code class="highlighter-rouge">foo</code> as an exposed service</strong>.</p>

<p>XYZ is configured to work with <em>first find</em> by default. if you wish to change this, a new key named <strong><code class="highlighter-rouge">defaultSendStrategy</code></strong> should be added to the <strong>selfConf</strong> key passed to xyz constructor. Built in middlewares can be imported from <code class="highlighter-rouge">xyz-core/src/Service/Middlewares/[...]</code>. Let’s set <code class="highlighter-rouge">send.to.all</code> function for <code class="highlighter-rouge">string.ms.js</code>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">stringMS</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'string.ms'</span><span class="p">,</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="na">seed</span><span class="p">:</span> <span class="p">[</span><span class="s1">'127.0.0.1:4000'</span><span class="p">],</span>
    <span class="na">defaultSendStrategy</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz-core/src/Service/Middleware/service.send.to.all'</span><span class="p">),</span>
    <span class="na">transport</span><span class="p">:</span> <span class="p">[{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'HTTP'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}]</span>
  <span class="p">},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span><span class="na">nodes</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span></code></pre></figure>

<p>Again, the code of <code class="highlighter-rouge">math.ms</code> does not have to change at all. In fact, math.ms does not care about any of this, since it’s sitting in the receiving side of this scenario.</p>

<p>Before going any further, you can see at this very point that <code class="highlighter-rouge">send.to.all</code> has had some effetcs!. run one math and one string service and see the difference in the response. Since <code class="highlighter-rouge">send.to.all</code> assumes multiple messages are being sent, it also returns an object of responses in return:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>response of mul <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">"127.0.0.1:4000:/mul"</span>:[null,10]<span class="o">}</span> <span class="o">[</span>err null]
</code></pre>
</div>

<p>So if we run three math.ms instances, <code class="highlighter-rouge">send.to.all</code> finds three target nodes and we expect to receive an object with three keys in return, each indicating the response of that node!</p>

<p>Let’s run 3 math services, and a dozen of string services. The configurations are similar to the previous section. <code class="highlighter-rouge">string.ms</code> has <em>send to all</em> as sendStrategy and <code class="highlighter-rouge">127.0.0.1:4000</code> as seed node.</p>

<p>You can run your services in the following order:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">//default math at port 4000
<span class="gp">$ </span>node math.ms.js

//default string at port 5000
<span class="gp">$ </span>node string.ms.js

// more string on different ports
<span class="gp">$ </span>node string.ms.js --xyz-transport.0.port 5001
<span class="gp">$ </span>node string.ms.js --xyz-transport.0.port 5002</code></pre></figure>

<p>at this point, each string will have receive a response like:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>response of mul <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">"127.0.0.1:4000:/mul"</span>:[null,10]<span class="o">}</span> <span class="o">[</span>err null]
</code></pre>
</div>

<p>As you add more <code class="highlighter-rouge">math.ms</code> to the system, all information regarding join event will be propagated to the system and string.ms will receive more and more response!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">//note that these new instances must have a seed node,
//otherwise they can not find the rest of the system!

<span class="gp">$ </span>node math.ms.js --xyz-transport.0.port 3999 --xyz-seed 127.0.0.1:4000
<span class="gp">$ </span>node math.ms.js --xyz-transport.0.port 3998 --xyz-seed 127.0.0.1:4000
<span class="gp">$ </span>node math.ms.js --xyz-transport.0.port 3997 --xyz-seed 127.0.0.1:4000</code></pre></figure>

<p>Similar to how we can override the port number, a single seed node can also be added by command line argument using the <code class="highlighter-rouge">--xyz</code> prefix.</p>

<p>At this point, you should expect to see:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>response of mul <span class="o">=</span>&gt; <span class="o">{</span>
  <span class="s2">"127.0.0.1:4000:/mul"</span>:[null,10],
  <span class="s2">"127.0.0.1:3998:/mul"</span>:[null,10],
  <span class="s2">"127.0.0.1:3997:/mul"</span>:[null,10],
  <span class="s2">"127.0.0.1:3999:/mul"</span>:[null,10]
<span class="o">}</span>
</code></pre>
</div>

<p>in each array response, the first index is the error and the second one is the actual response.</p>

<p>In fact, if you close one of the math.ms nodes, you’ll see the response to be:</p>

<p>Assuming tht you kill <code class="highlighter-rouge">math.ms@127.0.0.1:3998</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>response of mul <span class="o">=</span>&gt; <span class="o">{</span>
  <span class="s2">"127.0.0.1:4000:/mul"</span>:[null,10],
  <span class="s2">"127.0.0.1:3998:/mul"</span>:[
    <span class="o">{</span><span class="s2">"code"</span>:<span class="s2">"ECONNREFUSED"</span>,<span class="s2">"errno"</span>:<span class="s2">"ECONNREFUSED"</span>,<span class="s2">"syscall"</span>:<span class="s2">"connect"</span>,<span class="s2">"address"</span>:<span class="s2">"127.0.0.1"</span>,<span class="s2">"port"</span>:5001<span class="o">}</span>,
    null
  <span class="o">]</span>,
  <span class="s2">"127.0.0.1:3997:/mul"</span>:[null,10],
  <span class="s2">"127.0.0.1:3999:/mul"</span>:[null,10]
<span class="o">}</span>
</code></pre>
</div>

<blockquote>
  <p>Note that each xyz node will kick out-of-reach nodes after a certain threshold. You can learn more about it in the <a href="">Ping Types</a>.</p>
</blockquote>

<p>As you see, the first parameter is the error and the second parameter is the response. This happens because each node will not immediately assume that an other node is offline after one failure, so it will keep sending the message to it. If you wait for 10 ping, you will see that all nodes will eventually update their <code class="highlighter-rouge">systemConf</code> and will not send any message to this node.</p>

<p>Another interesting send strategy that you might want to implement and test is majority function. You can change the <code class="highlighter-rouge">send.to.all</code> in a way that it will send the message to all accpetable nodes, will wait for all responses, and will return with a single result, if all if the responses from different services were the same. If not, it will return an Error. Who knows, maybe you actually use this Microservice to do floating point calculations. Each machine handles floating point differently and the responses might actually differ!</p>

<p>Note that you can also pass the send strategy <strong><em>per call</em></strong>. This will override whatever send strategy you have already chosen in <code class="highlighter-rouge">selfConf</code>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">sendToAll</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz-core/src/Service/Middleware/service.send.to.all'</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">firstFind</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz-core/src/Service/Middleware/service.first.find'</span><span class="p">)</span>
<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">stringMS</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="na">servicePath</span><span class="p">:</span> <span class="s1">'mul'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="na">sendStrategy</span><span class="p">:</span> <span class="nx">sendToAll</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">response</span> <span class="nx">of</span> <span class="nx">mul</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span> <span class="p">[</span><span class="nx">err</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}]</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">stringMS</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="na">servicePath</span><span class="p">:</span> <span class="s1">'mul'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="na">sendStrategy</span><span class="p">:</span> <span class="nx">firstFind</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">response</span> <span class="nx">of</span> <span class="nx">mul</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span> <span class="p">[</span><span class="nx">err</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}]</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">)</span></code></pre></figure>

<h1 id="path-based-service-identification">Path based service identification</h1>

<p>Aside from Service discovery middlewares, xyz provides yet another way to make service invocation even more flexible. It’s called <strong>Path Base</strong> service identification. That is to say, each service (aka. function) that you expose, will be exposed on a certain path on that process. So far we have used a plain string as the service name. The truth is that those were paths too! XYZ has been adding a single <code class="highlighter-rouge">/</code> to each of them. Recall one of the logs printed from the previous section. Look at it again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  "127.0.0.1:4000:/mul":[null,10]}
</code></pre>
</div>

<p>As you see, the actual <strong>identifier of the service</strong> is actually: <strong>[IP]:[PORT]:/[PATH]</strong>.</p>

<p>Recalling from the last section, The <code class="highlighter-rouge">[IP]:[PORT]</code> portion of this identifier must be discovered and decided upon in the <strong>sending side</strong>, the caller. Once the IP and PORT has been resolved using a send strategy, the message will be sent to that node. The last part of the address, the <strong>:/[PATH]</strong>, will be used at the <strong>receiving side</strong>, which help the callee decide whihc of its exposed functions to invoke.</p>

<p>Of course, this does not separate these two identifiers entirely. As an example, in <code class="highlighter-rouge">first.find</code>, the sender must be aware of the <strong>PATH</strong> of services exposed by other nodes, while <code class="highlighter-rouge">send.to.target</code> will send a message to a specific <strong>IP:PORT</strong> regardless of the <strong>PATH</strong>.</p>

<p>As a naive example, let’s assume that our math service is super accurate and can add floating point numbers up to thousands digits of accuracy. But we don’t want to waste resource on simple integer calculations. Hence, we will divide our services into to section:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>decimal/add
decimal/mul

float/add
float/mul
</code></pre>
</div>

<p>Applying this turns out to be very easy!</p>

<p>Change the first parameter, the <em>Path</em>, of each function is math.ms:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mathMS.register('decimal/mul', (payload, response) =&gt; {
  response.send(payload.x * payload.y)
})

mathMS.register('decimal/add', (payload, response) =&gt; {
  response.send(payload.x + payload.y)
})

mathMS.register('float/mul', (payload, response) =&gt; {
  // let's add the float casting, just fore sake of our example!
  response.send(parseFloat(payload.x * payload.y))
})

mathMS.register('float/add', (payload, response) =&gt; {
  response.send(parseFloat(payload.x + payload.y))
})
</code></pre>
</div>

<p>If you run the stringMS now, it will get only <code class="highlighter-rouge">null</code>. This is natural because it is looking for <code class="highlighter-rouge">/mul</code>, while it only knows <code class="highlighter-rouge">/decimal/mul</code>.</p>

<p>Next, change the call path in stringMS:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>setInterval(() =&gt; {
  stringMS.call({servicePath: '/decimal/mul', payload: {x: 2, y: 5}}, (err, body, res) =&gt; {
    console.log(`my fellow service responded with ${JSON.stringify(body)}`)
  })
}, 2000)
</code></pre>
</div>

<p>As you see, now we get the same result.</p>

<p>The main purpose of paths is to allow:</p>

<ol>
  <li>better grouping and organization among services.</li>
  <li>allow more meaningful names and identification</li>
  <li>allow multiple calls at once -<em>Wildcard</em>-:</li>
</ol>

<p>Let’s see all of these in action! We will use the same configuration like the previous section.</p>

<p>First, let’s have string.ms make two message calls:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">stringMS</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span>
    <span class="na">servicePath</span><span class="p">:</span> <span class="s1">'/decimal/mul'</span><span class="p">,</span>
    <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="na">sendStrategy</span><span class="p">:</span> <span class="nx">firstFind</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="o">/</span><span class="nx">decimal</span><span class="o">/</span><span class="nx">mul</span> <span class="p">[</span><span class="nx">firstFind</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">body</span><span class="p">}</span> <span class="p">[</span><span class="nx">err</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}]</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">stringMS</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span>
    <span class="na">servicePath</span><span class="p">:</span> <span class="s1">'/decimal/*'</span><span class="p">,</span>
    <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
    <span class="na">sendStrategy</span><span class="p">:</span> <span class="nx">sendToAll</span>
  <span class="p">},</span>
  <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="o">/</span><span class="nx">decimal</span><span class="o">/*</span> <span class="p">[</span><span class="nx">sendToAll</span><span class="p">]</span><span class="o">=&gt;</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span> <span class="p">[</span><span class="nx">err</span> <span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">}]</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">)</span></code></pre></figure>

<p>Before testing this, let’s try and understand how it is going to work:</p>

<p>The first call is lucid. we try to find <code class="highlighter-rouge">/decimal/mul</code> in a node using <code class="highlighter-rouge">firstFind</code> which will eventually find one node that can respond to this.</p>

<p>But in the second case, you should know somethings beforehand. Specifically talking about <code class="highlighter-rouge">sendToAll</code>, this sendStrategy will take into consider both the <strong>IP:PORT</strong> and <strong>PATH</strong>. In other words, it will first resolve the path, if it contains <code class="highlighter-rouge">*</code>. Next it will iterate over nodes and find those who can respond to a specific path.</p>

<p>Taking this into account, in the second case, <code class="highlighter-rouge">/decimal/*</code> will first translate into [<code class="highlighter-rouge">decimal/mul</code>, <code class="highlighter-rouge">decimal/add</code>]. Next, all possible target nodes for each of these paths will be resolved and the message will be sent to all of them.</p>

<p>With these explanations in mind, the output of the previous  double call is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/decimal/mul [firstFind] =&gt; 10 [err null]
/decimal/* [sendToAll]=&gt; {
  "127.0.0.1:4000:/decimal/mul":[null,10],
  "127.0.0.1:4000:/decimal/add":[null,7]}
</code></pre>
</div>

<blockquote>
  <p>Note that this example is working only because we are using <code class="highlighter-rouge">service.send.to.all</code> as send strategy is second call. <code class="highlighter-rouge">first.find</code> would simple call either one of <code class="highlighter-rouge">/decimal/add</code> or <code class="highlighter-rouge">/decimal/mul</code> in only one of possible nodes</p>
</blockquote>

<p>Go ahead and try things like <code class="highlighter-rouge">*/mul</code> or even <code class="highlighter-rouge">/*/*</code>.</p>

<p>It would be helpful to mix the this section and the last one. Go ahead and run a few math.ms nodes and a single string.ms node with <code class="highlighter-rouge">sendToAll</code> as sendStrategy and see the output.</p>

<h4 id="note-on-valid-paths-and-wildcards">Note on valid Paths and wildcards</h4>

<p>Currently, XYZ path parser only supports characters and wildcards in paths. That is to say, when creating a new service, the valid regex is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/^(\/([a-zA-Z]|[1-9]|\*)+)*$/
</code></pre>
</div>

<p>and when calling a service, you can only call definite paths or full-wildcards. <code class="highlighter-rouge">abc/*/abc</code> is valid, albeit <code class="highlighter-rouge">abc/ab*/abc</code> is not. This is a work in progress and will change in the upcoming version.</p>

<h1 id="middlewares">Middlewares</h1>

<p>Middlewares are nothing new to you. You have already seen them. <code class="highlighter-rouge">send.to.all</code> was a simple middleware in xyz system. In this section we are going to get into the details of middleware and use them to develop an authentication mechanisms.</p>

<h3 id="middlewares-and-layers-in-xyz">Middlewares and Layers in XYZ</h3>

<p>So far, our system has been plain open! No authentication. That is not good. The good news is that XYZ does not provide any authentication mechanisms by default. You heard me, <strong>No authentication mechanisms</strong>. As opposed to application-dependent steps like authentication which are not compulsory in xyz, <strong>middlewares</strong> are. That is to say, whatever happens, requests will go through a middleware in xyz.</p>

<p>In order to understand the place and organization of middleware in xyz, you should get a bit more familiar with it.</p>

<blockquote>
  <p>XYZ consists of 3 main layers. <code class="highlighter-rouge">xyz-core</code>, <code class="highlighter-rouge">Service-Repository</code> and <code class="highlighter-rouge">Transport</code>. The pipeline that will conevy a message from one layer to another is a <strong>middleware</strong>.</p>
</blockquote>

<h3 id="middleware-stacks">Middleware Stacks</h3>

<p>Middlewares are implemented using the <a href="/apidoc/GenericMiddlewareHandler.html">GenericMiddlewareHandler</a> Class in XYZ. this class will register an array of functions and passes an object (aka. parameters) through this array of middlewares.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>MiddlewareStack : [Function, Function, Function, ... , Function]
</code></pre>
</div>

<p>As an example, Whenever a request is received and parsed in Transport Layer, a middleware function will pass it to the Service repository layer. This action will happen in the last function placed in the last index of this middleware in Transport layer.</p>

<p>This enables us to <strong>prepend / append</strong> more functions to this array and <strong>perform any type of pre/post process</strong> on every request. After seeing the syntax structure of each middleware in the next section, we will actually use this to add a generic authentication middleware to our system.</p>

<h3 id="middleware-stacks-in-xyz">Middleware Stacks in XYZ</h3>

<p>The overall structure of xyz, in the simplest form can be explained like this:</p>

<p><img src="/assets/img/arch-c.png" alt="xyz-arch" /></p>

<p>Although it is good for you to have a glimpse of some components like <strong><em>multiple servers</em></strong> and <strong><em>routes</em></strong>, this image is too complicated for this tutorial. Let’s relax this into something simpler:</p>

<p><img src="/assets/img/arch-s.png" alt="xyz-arch-simple" /></p>

<p>Let’s see how these components behave when you send or receive a message:</p>

<h4 id="sending-a-message">1) Sending a message</h4>

<p>Whenever you send a message, the following steps will be taken:</p>

<ul>
  <li>You invoke the <code class="highlighter-rouge">.call()</code>, which lives in <code class="highlighter-rouge">xyz-core</code> layer. (Basically, all of the functions that you might need to use directly live in <code class="highlighter-rouge">xyz-core</code>)</li>
  <li><code class="highlighter-rouge">xyz-core</code> will then pass this message to <code class="highlighter-rouge">service-repository</code> layer. service-repository will then pass the message to a send strategy function in order to resolve the destination node of this message. this <em>sendStrategy</em> function should also invoke the <code class="highlighter-rouge">Transport</code> layer.</li>
  <li>The <code class="highlighter-rouge">Transport</code> layer itself does not do much! It’s the middlewares of Transport layer that do most of the job. Almost immediatly, the Transport layer will pass the message to an <strong>Outgoing Middleware Stack</strong>. This outgoing middleware stack will apply all kinds of processes over the message object, and finally, in the last function of this middleware stack, the actual http call will be made and the message will be exported.</li>
</ul>

<h4 id="receiving-a-message">2) Receiving a message</h4>

<p>Whenever you receive a message, the following steps will be taken:</p>

<ul>
  <li>A <strong>Transport Layer Server</strong> (HTTP by default) will parse the message, including body and will convert it to a standard format.</li>
  <li>This message will then be passed to a <strong>Server Middleware Stack</strong> for further processes.</li>
  <li>Similar to sending a message, you can add functions to this stack for extra process, but, nonetheless, in the last function of this Middleware Stack, a function will pass the message to <code class="highlighter-rouge">Service-Repository</code> layer (using Node’s <code class="highlighter-rouge">EventEmitter</code> class).</li>
  <li>Service-Repository will then parse the message, extract its <code class="highlighter-rouge">servicePath</code> and invoke the appropriate function, if any.</li>
</ul>

<p><code class="highlighter-rouge">xyz-core</code> overrides the <code class="highlighter-rouge">console.log</code> function and whenever you log an instance of the <code class="highlighter-rouge">xyz-core</code>, all of its components will be displayed. Now is a good time to see this and relate these printed information to what we have already learned.</p>

<p>Add the following to <code class="highlighter-rouge">math.ms.js</code> in the last line:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">mathMS</span><span class="p">)</span></code></pre></figure>

<p>You are expected to see the following as output:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">____________________  GLOBAL ____________________
selfConfig:
  <span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"math.ms"</span>,
  <span class="s2">"defaultSendStrategy"</span>: <span class="s2">"./Middleware/service.first.find"</span>,
  <span class="s2">"logLevel"</span>: <span class="s2">"info"</span>,
  <span class="s2">"seed"</span>: <span class="o">[]</span>,
  <span class="s2">"transport"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"HTTP"</span>,
      <span class="s2">"port"</span>: <span class="s2">"4000"</span>,
      <span class="s2">"event"</span>: 1
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"host"</span>: <span class="s2">"127.0.0.1"</span>,
  <span class="s2">"defaultBootstrap"</span>: <span class="nb">true</span>,
  <span class="s2">"cli"</span>: <span class="o">{</span>
    <span class="s2">"enable"</span>: <span class="nb">false</span>,
    <span class="s2">"stdio"</span>: <span class="s2">"console"</span>
  <span class="o">}</span>
<span class="o">}</span>
systemConf:
  <span class="o">{</span>
  <span class="s2">"nodes"</span>: <span class="o">[</span>
    <span class="s2">"127.0.0.1:4000"</span>
  <span class="o">]</span>
<span class="o">}</span>
Bootstrap Functions:
  _basicPingBootstrap
____________________  SERVICE REPOSITORY ____________________

Middlewares:
  service.discovery.mw <span class="o">||</span> firstFind[0]
Services:
  anonymousFN @ /decimal/mul
  anonymousFN @ /decimal/add
  anonymousFN @ /float/mul
  anonymousFN @ /float/add

____________________  TRANSPORT LAYER ____________________
Transport:
  outgoing middlewares:
    call.dispatch.mw <span class="o">[</span>/CALL] <span class="o">||</span> _httpExport[0]
    ping.dispatch.mw <span class="o">[</span>/PING] <span class="o">||</span> _httpExport[0]

  HTTPServer @ 4000 ::
    Middlewares:
    call.receive.mw <span class="o">[</span>/CALL] <span class="o">||</span> _httpMessageEvent[0]
    ping.receive.mw <span class="o">[</span>/PING] <span class="o">||</span> _pingEvent[0]</code></pre></figure>

<p>Now, some of these information are new to you, and we don’t want to focus on them for now. We just want to verify what we already learned.</p>

<p>In <strong>GENERAL</strong> section you can see most of the information that you pass to the <code class="highlighter-rouge">XYZ</code> constructor. Those that are new are the default values for the information that you skipped. <code class="highlighter-rouge">transport[]</code>, <code class="highlighter-rouge">host</code>, <code class="highlighter-rouge">defaultSendStrategy</code> are some of the keys that you are familiar with them.</p>

<p>In <strong>TRANSPORT LAYER</strong> section you can the list of all of the function that you have exposed using <code class="highlighter-rouge">.register()</code>. Also, you see a component called <code class="highlighter-rouge">service.discovery.mw</code>. This middleware, by default has only one function, which is <code class="highlighter-rouge">firstFind</code>. Whenver you change the <code class="highlighter-rouge">sendStrategy</code>, this function will change (change the <code class="highlighter-rouge">defaultSendStrategy</code> in <code class="highlighter-rouge">selfConf</code> and see this log again!)</p>

<blockquote>
  <p>Note: at current state of xyz, the Service-Repository’s <code class="highlighter-rouge">service.discovery.mw</code> can have <strong>only one</strong> function.</p>
</blockquote>

<p>Looking further into <strong>TRANSPORT</strong> section, we can find some more relevant information. You can see that each node has a number of <strong>outgoing message middlewares</strong> and a number of servers, each of them having a number of <strong>server middlewares</strong>, each for one route. For now, you can ignore the routes mentioned in the log. xyz uses the default <code class="highlighter-rouge">/CALL</code> route for all messages sent using <code class="highlighter-rouge">.call()</code> and <code class="highlighter-rouge">/PING</code> route is used by the default ping.</p>

<p>Focusing on the <code class="highlighter-rouge">/CALL</code> section, in the outgoing section you can see that <strong>outgoing middlewares</strong> currently have only one function, <strong>_httpExport</strong>. This function will immediately export a message using a HTTP message. As an example, you will learn in <a href="">Routes and Servers</a> section that you can replace this function with something like <strong>_udpExport</strong>.</p>

<p>In the <strong>Server</strong> section of <strong>TRANSPORT</strong> you can see that the middleware of <code class="highlighter-rouge">/CALL</code> has only one function by default, the <code class="highlighter-rouge">_httpMessageEvent</code> which will invoke the Service-Repository layer. This means that whenever <code class="highlighter-rouge">math.ms</code> receives a message from another node, it will immediately pass it to the service layer and no extra process is done.</p>

<p><em>The main power of xyz in allowing <strong>configurability</strong> is the fact that you can always manipulate all of the middleware stacks</em>.</p>

<blockquote>
  <p>Due to the fact that critical actions such as passing a request object to the upper/lower layer or passing a request out to the HTTP layer happen in middleware, it is crucially important to be very careful with them. Specifically, some middlewares are placed in xyz by <strong>default</strong>. They should remain in their place, unless you have a good reason to remove them.</p>
</blockquote>

<p>Knowing these information about the architecture of xyz, we will now use our knowledge to manipulate a middleware and add custom function it.</p>

<h3 id="middleware-syntax">Middleware syntax</h3>

<p>As mentioned above, each middleware is <strong>nothin but a function</strong>. Although you are the write of middlewares in most cases, you are not the one who invokes them, <code class="highlighter-rouge">xyz-core</code> is. Hence, xyz-core will decide which paramters will be passed to each middleware.</p>

<p><code class="highlighter-rouge">xyz-core</code> calls each Middleware function with the following parameters:</p>

<ul>
  <li><code class="highlighter-rouge">params</code>: an array of parameters values passed to the middleware function. This paramter can be variable depending on the place of the middleware. As an example, a HTTP server will invoke a Middleware function with different parameters than a UDP server.</li>
  <li><code class="highlighter-rouge">next</code>: function that will ignore the rest of the execution of <strong>this middleware</strong> and invoke the <strong>next</strong> function in the stack.</li>
  <li><code class="highlighter-rouge">end</code>: will end of the execution of the entire stack.</li>
  <li><code class="highlighter-rouge">xyz</code>: a reference to the current xyz object. This is useful because all of the information required, such as configurations, Service-Repository layer etc. can be accesses from this object.</li>
</ul>

<p>In order to see the value of <code class="highlighter-rouge">params</code>, we can always see the <a href="/apidoc/src_Transport_HTTP_http.server.js.html#line57">source code</a> or <a href="/apidoc/HTTPServer.html">API DOC</a>. We can see from the API doc that the following values will be passed to a HTTP server middleware:</p>

<ul>
  <li><strong>req</strong>: the request object</li>
  <li><strong>resp</strong>: the response object</li>
  <li><strong>body</strong> parsed body. also available in req object</li>
  <li><strong>port</strong>: port of this server</li>
</ul>

<p>Keeping this ideas in mind, let’s write a simple logger middleware:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>let _dummyLogger = function (params, next, end) {
  console.log('i was called! now what?')
  let port = params[3]
  let body = params[2]
  console.log(`LOGGER :: http message received on port ${port} with body ${JSON.stringify(body)}`)
  next()
}
module.exports = _dummyLogger
</code></pre>
</div>

<p>This is the minimum structure required for each middleware. We expect this middleware to be called per <strong>each http message</strong> and it should log some information about it.</p>

<p>Next, let us see how we can insert this dummy logger to the system. Each middleware provides a method for inserting a function to a specific index of it. The tricky part is <strong>accessing</strong> that middleware. Since middlewares can be numerous, <code class="highlighter-rouge">xyz-core</code> does not provide a generic function for inserting middlewares (something like <code class="highlighter-rouge">MathMS.insertMw(...)</code>). This is because xyz-core must first know <strong>which middleware</strong>!</p>

<p>the <code class="highlighter-rouge">middlewares()</code> method in <code class="highlighter-rouge">xyz-core</code> return an object containing all middlewares in the system. Next, you should choose your target from this object. Let’s jump right into the code:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">_dummyLogger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./dummy.logger'</span><span class="p">)</span>
<span class="nx">mathMS</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">server</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">)(</span><span class="mi">4000</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_dummyLogger</span><span class="p">)</span></code></pre></figure>

<p>We first choose <code class="highlighter-rouge">.transport</code> layer, than a route named <code class="highlighter-rouge">CALL</code>, which is the default route of all messages. Next we choose a server on port 4000, which is the default port of <code class="highlighter-rouge">math.ms.js</code> and finally, we insert the function to that middleware using <code class="highlighter-rouge">.register()</code> at index <code class="highlighter-rouge">0</code>.</p>

<p>Now that you have seen an example of this, seeing its <a href="/apidoc/xyz.js.html#line152">source code</a> can clear things up.</p>

<p>If you run math.ms now and send some messages to it usign string.ms, you should se something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>i was called! now what?
LOGGER :: http message received on port 4000 with body {"userPayload":{"x":2,"y":5},"service":"/decimal/mul"}
</code></pre>
</div>

<p>if you put a log inside <code class="highlighter-rouge">math.ms.js</code> when registering <code class="highlighter-rouge">/decimal/mul</code>,you see that our new middleware was invoked before the response was sent.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">mathMS</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'decimal/mul'</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'decimal/mul was called!'</span><span class="p">)</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">jsonify</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
<span class="p">})</span></code></pre></figure>

<p>for more information about inserting middlewares and <code class="highlighter-rouge">.register()</code>, you can see <a href="http://localhost:2000/apidoc/GenericMiddlewareHandler.html">Generic Middlewares Handler</a> class</p>

<p>Note that except the payload, all of these parameters will be used in the last middleware to create and send a HTTP request. Altering them will indeed have consequences. Albeit, not all alterations are harmful. As an example, consider the following scenarios:</p>

<ul>
  <li>Applying a pre/post-processing to all request, like adding fix headers, message encryption or serialization.</li>
  <li>logging systems</li>
  <li>validation: note that by calling <code class="highlighter-rouge">end()</code>, the request will be dismissed. Furthermore, you have the response object (<code class="highlighter-rouge">resp</code>) and you can respond to an unauthorized message in a middleware and don’t even bother sending it to Service-Repository layer!</li>
  <li>reusability of middlewares</li>
  <li>last but not least! authentication. Although this is analogous to validation, we are going to mention it separately since we are going to implement one in the next section:</li>
</ul>

<h3 id="an-authentication-middleware">An authentication middleware:</h3>

<p>Suppose that your system uses a very simple  authentication system, a shared-secret mechanism. This is because we don’t want to complicate matters with different authentication mechanism, instead, we want to focus on how to add <strong>any</strong> authentication mechanism to xyz. You want authentication to happen in Transport layer. This is generally better because the Transport layer can drop unauthorized requests immediately and the Service-Repository layer, which is more critical, won’t be bothered to check them twice.</p>

<p>We are going to place two middlewares in <strong>Transport layer</strong> for this purpose, namely in <strong>HTTP Server middleware</strong>*, the default Transport server.</p>

<p>One middleware is going to be placed in the <strong>outgoing</strong> route** and it should append a <em>shared secret</em> to the message’s body. Another middleware will be placed in the <strong>Server route</strong> and it should check to see if that shared secret exists or not. The receiving middleware can destroy the message if it does not have correct secret and this keeps the rest of the system safe.</p>

<p>The last note is to get familiar with parameters of an outgoing middleware, similar to the server middleware which we have already seen. An outgoing middleware has the following parameters:</p>

<ul>
  <li>params:
an object with two elements:
    <ul>
      <li>requestConfig. The data of the message is stored in a key in <code class="highlighter-rouge">requestConfig</code> named <code class="highlighter-rouge">json</code>. Therefore, if we are to add a data to the request, we should add keys to <code class="highlighter-rouge">requestConfig.json</code>.</li>
      <li>responseCallback</li>
    </ul>
  </li>
  <li>next()</li>
  <li>end()</li>
  <li>xyz</li>
</ul>

<p>The sender side is fairly (perhaps more than <em>fairly</em>) simple:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//auth.send.js</span>
<span class="kr">const</span> <span class="nx">SECRET</span> <span class="o">=</span> <span class="s1">'SHARED_SECRET'</span>

<span class="kd">let</span> <span class="nx">_authSend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// params[0] is the requestConfig</span>
  <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">json</span><span class="p">.</span><span class="nx">authorization</span> <span class="o">=</span> <span class="nx">SECRET</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'auth header added'</span><span class="p">)</span>
  <span class="nx">next</span><span class="p">()</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_authSend</span></code></pre></figure>

<p>and in the receiving side:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//auth.receive.js</span>
<span class="kr">const</span> <span class="nx">SECRET</span> <span class="o">=</span> <span class="s1">'SHARED_SECRET'</span>

<span class="kd">let</span> <span class="nx">_authReceive</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kd">let</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">authorization</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">authorization</span> <span class="o">===</span> <span class="nx">SECRET</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'auth accpeted'</span><span class="p">)</span>
    <span class="c1">// pass the request to next middleware</span>
    <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'auth failed'</span><span class="p">)</span>
    <span class="c1">// it's better to also close the request immediately</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
    <span class="nx">end</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_authReceive</span></code></pre></figure>

<p>Similarly, we can insert these middlewares into the system using:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// math.ms.js</span>
<span class="kd">let</span> <span class="nx">_authSend</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./auth.send'</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">_authReceive</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./auth.receive'</span><span class="p">)</span>
<span class="nx">mathMS</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">server</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">)(</span><span class="mi">4000</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_authReceive</span><span class="p">)</span>
<span class="nx">mathMS</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">client</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_authSend</span><span class="p">)</span></code></pre></figure>

<p>and</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// string.ms.js</span>
<span class="kd">let</span> <span class="nx">_authSend</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./auth.send'</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">_authReceive</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./auth.receive'</span><span class="p">)</span>
<span class="nx">stringMS</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">server</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">)(</span><span class="mi">5000</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_authReceive</span><span class="p">)</span>
<span class="nx">stringMS</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">client</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_authSend</span><span class="p">)</span></code></pre></figure>

<ul>
  <li>Note that adding a middleware to an outgoing route does not require a <code class="highlighter-rouge">port</code> to be specified. This is because outgoing message are independent of the incoming messages.</li>
  <li>Note that the <code class="highlighter-rouge">string.ms</code> is listening on port 5000, hence we must indicate this when adding middleware</li>
</ul>

<blockquote>
  <p>You might ask why are we indicating 4000 and 5000 as the port? doesn’t the system already know that? Yes it knows. But the point is that this tutorial is centered around HTTP transport which is the default Transport layer. You will soon learn how to add multiple servers to your node and use them. In this case, you must explicitly indicate the port to point to a specific middleware.</p>
</blockquote>

<p>Again, note that what you add to the <code class="highlighter-rouge">json</code> key is not available to the application layer. That is to say, you do not need to explicitly delete it from the object. Add a log to the receiving function and and double check this.</p>

<p>If you run both systems now, you see that everything is working as expected and the two systems can still communicate. Change the <code class="highlighter-rouge">const SECRET = .. </code> value in one node and see how it causes messages to be ignored by the Receiving.</p>

<h1 id="where-to-next">Where to next?</h1>

<p>Congrats! you have just learned something very awesome. This tutorial teaches you almost enough to <strong>use</strong> xyz, and some third party middleware packages. But, if you are interested in knowing more, you are encouraged to read the <a href="/documentation/advance">Advance Topics</a> and <a href="/documentation/In-depth">In-depth</a> section.</p>

<hr />

  </div>
</div>

<script type="text/javascript">
var side = $("#___side")
var $side = $('#___side > ol')
var heads = $('h1')
function getSideBarElem(name, id) {
  return `<li>
    <a href="#${id}">
      ${name.replace(/-/g, ' ')}
    </a>
  </li>`
}
$.each( heads, function(idx, elem) {
  $side.append(getSideBarElem($(elem).html(), elem.id))
})

// $("#__side").css('width', $("#__side").parent().width() + 'px')

</script>


  </section>
  
<style media="screen">
  .site-footer{
    padding: 30px;
    color: var(--light-color);
    background-color: var(--very-dark);
  }
</style>
<footer class="site-footer">
  <span class="site-footer-owner">
    <a href="http://localhost:1999">NODE XYZ</a>
     is maintained by <a href="">Kian Peymani & Ajand </a></span>
  <small>
    <br>
    <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a></small>
</footer>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" charset="utf-8"></script>

</body>
</html>

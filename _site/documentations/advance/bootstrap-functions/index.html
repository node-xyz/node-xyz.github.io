<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>Bootstrap functions - Node XYZ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="/assets/css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- <link rel="stylesheet" href="/assets/css/main.css"> -->
  <link rel="stylesheet" href="/assets/css/stylish.css">
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>

</head>

<body>

<style media="screen">
body {
  background-color: var(--light-color);
  color: var(--dark-color)
}
</style>
<style media="screen">
/* Nav */
#mainNav {
  color: var(--light-color) !important;
}

</style>

<nav class="navbar navbar-inverse" style="margin:0" id="mainNav">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand spacing" href="/">NODE XYZ</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Repositories <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="padding"> CORE REPOSITORIES </li>
            <li><a href="https://github.com/node-xyz/xyz-core" class="spacing">xyz.core</a></li>
            <li><a href="https://github.com/node-xyz/xyz-cli" class="spacing">xyz.cli</a></li>
            <li role="separator" class="divider"></li>
            <li class="padding"> ADDITIONAL </li>
            <li><a href="https://github.com/node-xyz/xyz.monitor.basic.bootstrap" class="spacing">xyz.monitor</a></li>
            <li><a href="https://github.com/node-xyz/xyz.ping.swim.bootstrap" class="spacing">xyz.ping.swim</a></li>
            <li><a href="https://github.com/node-xyz/xyz.ping.stochastic.bootstrap" class="spacing">xyz.ping.stochastic</a></li>
          </ul>
        </li>
      </ul>

      <ul class="nav navbar-nav navbar-left">
        <!-- <li><a href="#">Link</a></li> -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Documentations <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="padding"> READING </li>
            <li><a href="/documentations/getting-started">Getting Started</a></li>
            <li><a href="/documentations/advance">Advance Topics</a></li>
            <li><a href="/apidoc">API DOC</a></li>
            <li role="separator" class="divider"></li>
            <li class="padding"> EXAMPLES </li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.getting.started">xyz.getting.started</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.logger.bootstrap">xyz.logger.bootstrap</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.auth.basic.receive">xyz.auth.basic.receive</a></li>
            <li class="spacing"><a href="https://github.com/node-xyz/xyz.example.auth.basic.send">xyz.auth.basic.send</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<section class="container">

  <ol class="breadcrumb" style="margin: 10px; color: white;">
    <li><a class='spacing' href="/">Node XYZ </a></li>
    
    
    
    
    
    
    
    

    
      

    
      
      
      <li >
        <a style="color: inherit" href="/documentations/">documentation</a>
      </li>
      
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      
      
    
    
    
    

    
      

    
      

    
      
      
      <li >
        <a style="color: inherit" href="/documentations/advance/">advance</a>
      </li>
      
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      
      
    
    
    
    

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      

    
      
      
      <li class="active">
        <a style="color: inherit" href="/documentations/advance/bootstrap-functions/">bootstrap-function</a>
      </li>
      
      
      
    </ol>

    <hr>


    <div class="row">
  <div class="col col-md-2" id="__side">
    <div id="___side">
      <p class="spacing"> CONTENTS </p>
      <ol style="padding-left:5px">
      </ol>

    </div>
  </div>

  <div class="col col-md-10">
    <p>Configuring an xyz instance can sometimes be annoying. Many nodes want to have the same configurations, same middlewares etc., but is it good to copy and paste a chunk of code in all of these microservices? I mean, think about it, Aside from <code class="highlighter-rouge">.register</code> which creates new endpoints for functions, and is dependent to the <strong>business logic</strong>, there is a good chance that most of the lines of the microservices that you are writing are the same among all of the microservices in that application/project. One of the ways to encapsulate these common steps in an isolated environment so that they can be reused as a <strong>Bootstrap function</strong>.</p>

<h1 id="bootstrap-functions">Bootstrap functions</h1>

<p>Bootstrap functions are… nothing in fact. They’re just <strong><em>functions that take in the current xyz instance as argument and are free to make any modifications to it</em></strong>. This can include <strong>exposing new functions</strong>, listening to <strong>events</strong>, registering new <strong>middlewares</strong> etc.</p>

<h1 id="case-study-node-monitor">Case Study: Node Monitor</h1>
<p>A complete example of this is the <a href="https://github.com/node-xyz/xyz.monitor.basic.bootstrap">Monitor Bootstrap function</a>. What this bootstrap function basically does is that it inserts two middlewares in the transport layer, which count the number of messages sent and received. Finally it will launch an express HTTP server to serve this information, alongside some additional data about the system, to a specific end point.</p>

<p>Let’s see the big picture before going any further!</p>

<p><img src="/assets/img/monitor.info.png" alt="" /></p>

<p>As you see, the monitor bootstrap will automatically insert two new middlewares, indicated by green color in the image. These middlewares will measure the message rate <strong>at transport level</strong> and will report them to a new component, independent of <code class="highlighter-rouge">xyz-core</code>, an express server.</p>

<p>Keeping these information in mind, now we can see the code:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_basicMonitor</span> <span class="p">(</span><span class="nx">xyz</span><span class="p">,</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*
  Initialize a simple express server
   */</span>
  <span class="nx">logger</span> <span class="o">=</span> <span class="nx">xyz</span><span class="p">.</span><span class="nx">logger</span>
  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/lib'</span><span class="p">))</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/index.html'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/all'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="na">load</span><span class="p">:</span> <span class="nx">load</span><span class="p">,</span> <span class="na">inspectJSON</span><span class="p">:</span> <span class="nx">xyz</span><span class="p">.</span><span class="nx">inspectJSON</span><span class="p">(),</span> <span class="na">inspect</span><span class="p">:</span> <span class="nx">xyz</span><span class="p">.</span><span class="nx">inspect</span><span class="p">()})</span>
  <span class="p">})</span>
  <span class="kd">let</span> <span class="nx">listener</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="err">`</span><span class="nx">monitor</span> <span class="nx">server</span> <span class="nx">started</span> <span class="nx">at</span> <span class="nx">port</span> <span class="nx">$</span><span class="p">{</span><span class="nx">listener</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="cm">/*
  Register required middlewares
   */</span>
  <span class="nx">xyz</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">server</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">)(</span><span class="nx">xyz</span><span class="p">.</span><span class="nx">id</span><span class="p">().</span><span class="nx">port</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">monitorCallReceive</span><span class="p">)</span>
  <span class="nx">xyz</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">transport</span><span class="p">.</span><span class="nx">client</span><span class="p">(</span><span class="s1">'CALL'</span><span class="p">).</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
    <span class="nx">monitorCallSend</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// will be used by the user of this bootstrap function</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="nx">_basicMonitor</span><span class="p">,</span>

  <span class="c1">// will be used by the two middlewares inserted</span>
  <span class="na">setSendLoad</span><span class="p">:</span> <span class="p">(</span><span class="nx">aLoad</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">load</span><span class="p">.</span><span class="nx">snd</span> <span class="o">=</span> <span class="nx">aLoad</span>
  <span class="p">},</span>
  <span class="na">setRcvLoad</span><span class="p">:</span> <span class="p">(</span><span class="nx">aLoad</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">load</span><span class="p">.</span><span class="nx">rcv</span> <span class="o">=</span> <span class="nx">aLoad</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you see, inside the bootstrap function, we manipulate a <code class="highlighter-rouge">xyz</code> parameter which is supposed to be passed into this function when it is being invoked. This parameter can be treated exactly as if it were an instance of the <code class="highlighter-rouge">XYZ</code> class. To simplify this even more:</p>

<p>Inside your normal code</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({...})</span>

<span class="nx">ms</span><span class="p">.</span><span class="nx">middlewres</span><span class="p">().</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_fooMw</span><span class="p">)</span></code></pre></figure>

<p>inside a bootstrap function:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">bootstrapFoo</span><span class="p">(</span><span class="nx">xyz</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">xyz</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">().</span><span class="nx">register</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_fooMw</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>It can also be seen that this simple monitor example will insert these middlewares to the default <code class="highlighter-rouge">CALL</code> route, located on the <strong>primary server and port</strong> of the node by default. This bootstrap function can be configured to work with multiple servers and outgoing routes, but that is not the our primary concern right now. You can see the repository of this bootstrap function for more information.</p>

<h4 id="notes">Notes</h4>

<ul>
  <li>Every bootstrap module must return a function (the actual bootstrap function) that takes the <code class="highlighter-rouge">xyz</code> object as an argument. In this case, this bootstrap function exports <code class="highlighter-rouge">bootstrap: _basicMonitor</code> which will be later used to apply this bootstrap function.</li>
  <li>Inside a bootstrap function, you are allowed to do almost any thing. In this case, we are creating a very simple express server to serve a single html file and a json API and we are registering two new middlewares inside the system.</li>
  <li>Theses two middlewares that we are exposing will later on use
    <div class="highlighter-rouge"><pre class="highlight"><code>setSendLoad: (aLoad) =&gt; {
  load.snd = aLoad
},
setRcvLoad: (aLoad) =&gt; {
  load.rcv = aLoad
}
</code></pre>
    </div>
    <p>to set an estimate value for the load on the node. These values will then be served through the HTTP server.</p>
  </li>
</ul>

<p>Assuming that we have this bootstrap function, you could use it with:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({...})</span>
<span class="kd">let</span> <span class="nx">_basicMonitor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./_basicMonitor'</span><span class="p">)</span>

<span class="nx">_basicMonitor</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span></code></pre></figure>

<p>This would work, but we highly recommend you to use this method:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({...})</span>
<span class="kd">let</span> <span class="nx">_basicMonitor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./_basicMonitor'</span><span class="p">)</span>

<span class="nx">ms</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">(</span><span class="nx">_basicMonitor</span><span class="p">)</span></code></pre></figure>

<p>This allows an xyz instance to keep track of its bootstrap functions and ensure their compatibility, if required. Aside form that, it can output its list of bootstrap functions in logs. You have already this when you use <code class="highlighter-rouge">console.log</code> on an instance of xyz. Take another look if you haven’t seen the bootstrap section printed!</p>

<p>So, given that this bootstrap function is written once, you can always use it inside any of your microservices with just one (or two, including the <code class="highlighter-rouge">require</code> statement) line of code:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">let</span> <span class="nx">xyzMonitor</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'xyz.monitor.bootstrap'</span><span class="p">).</span><span class="nx">bootstrap</span>
<span class="kd">let</span> <span class="nx">mathMs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XYZ</span><span class="p">({</span>
  <span class="na">selfConf</span><span class="p">:</span> <span class="p">{...},</span>
  <span class="na">systemConf</span><span class="p">:</span> <span class="p">{</span> <span class="na">nodes</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">})</span>

<span class="nx">mathMs</span><span class="p">.</span><span class="nx">bootstrap</span><span class="p">(</span><span class="nx">xyzMonitor</span><span class="p">,</span> <span class="mi">7000</span><span class="p">)</span></code></pre></figure>

<p>After you set up this bootstrap function, you can view a nice monitoring page at your localhost (and on port <code class="highlighter-rouge">7000</code> in this case):</p>

<p><img src="/assets/img/monitor.example.png" alt="example monitor app" /></p>

<p>This bootstrap function is available on both npm and github. You can install and use it using:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>npm install xyz.monitor.basic.bootstrap
</code></pre>
</div>

  </div>
</div>

<script type="text/javascript">
var side = $("#___side")
var $side = $('#___side > ol')
var heads = $('h1')
function getSideBarElem(name, id) {
  return `<li>
    <a href="#${id}">
      ${name.replace(/-/g, ' ')}
    </a>
  </li>`
}
$.each( heads, function(idx, elem) {
  $side.append(getSideBarElem($(elem).html(), elem.id))
})

// $("#__side").css('width', $("#__side").parent().width() + 'px')

</script>


  </section>
  
<style media="screen">
  .site-footer{
    padding: 30px;
    color: var(--light-color);
    background-color: var(--very-dark);
    margin-top: 40px;
  }
</style>
<footer class="site-footer">
  <span class="site-footer-owner">
    <a href="http://localhost:1999">NODE XYZ</a>
     is maintained by <a href="">Kian Peymani & Ajand </a></span>
  <small>
    <br>
    <span class="site-footer-credits">This page was generated and hosted by <a href="https://pages.github.com">GitHub Pages</a></small>
</footer>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" charset="utf-8"></script>

</body>
</html>
